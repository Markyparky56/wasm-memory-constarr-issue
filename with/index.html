<html>
  <head>
    <script>
      function fetchAndCompileWasmModule(urls) {
        return Promise.all(urls.map(url => {
          return fetch(url)
          .then(res => {
            if(res.ok)
              return res.arrayBuffer();
            throw new Error("Unable to fetch WebAssembly file ${url}");
          })
          .then(bytes => WebAssembly.compile(bytes));
        }));
      }

      let mem = new WebAssembly.Memory({initial: 1});
      let mod = null, memMod = null;
      let compiledMemory, compiledMain;
      fetchAndCompileWasmModule(["./main.withconstfloatarr.opt.wasm", "./memory.wasm"])
      .then(([main, memory]) => {
        compiledMemory = memory;
        return WebAssembly.instantiate(memory, {
          env: {
            memory: mem
          }
        })
        .then(m => {
          compiledMain = main;
          memMod = m;
          return WebAssembly.instantiate(main, {
            env: {
              malloc: memMod.exports.malloc,
              free: memMod.exports.free,
              memcpy: memMod.exports.memcpy,
              memory: mem
            }
          });
        })
        .then(m => {
          mod = m;
          console.log(mod.exports.GetFloatArr(8));
        });
      });
    </script>
  </head>
</html>